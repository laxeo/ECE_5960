<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>ECE 5960 LAB 3</title>
        <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version1)-->
        <script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
            <a class="navbar-brand js-scroll-trigger" href="#page-top">
                <span class="d-block d-lg-none">Tongqing Zhang</span>
                
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html">MainPage</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab1.html">LAB 1</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab2.html">LAB 2</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#lab3">LAB 3</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab4.html">LAB 4</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab5.html">LAB 5</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab6.html">LAB 6</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab7.html">LAB 7</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab8.html">LAB 8</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab9.html">LAB 9</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab10.html">LAB 10</a></li>
                    <li class="nav-item"><a class="nav-link" href="lab11.html">LAB 11</a></li>
                </ul>
            </div>
        </nav>
        <!-- Page Content-->
        <div class="container-fluid p-0">
            <section class="resume-section" id="lab3">
                <div class="resume-section-content">
                    <div class="d-flex flex-column flex-md-row justify-content-between mb-4"><h2 class="mb-2">LAB 3 - Sensors</h2>
                    <div class="flex-shrink-0"><span class="text-primary2" >Feb 10<sup>th</sup>, 2022</span></div>
                    </div>
                    
                    <div class="flex-grow-1">
                        <h3 class="mb-1">Wiring</h3>
                        <div class="subheading mb-2">Wire two ToFs and IMU to the Artemis Board</div>
                        <p>In this part, I just imitated the example robot showed by TA to wire all the parts together:
                            <br>
                            1. Connect the Artemis Board to one ToF
                            <br>
                            2. Connect the ToF to IMU
                            <br>
                            3. Connect the IMU to the other ToF
                            <br>
                            In addition, I also connect xshuts of the ToFs to wires with a female header for changing their address.
                        </p>
                        <div align="center"><iframe width="640" height="360" src="https://www.youtube.com/embed/dYatm_SQZ-E" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
                        <p>
                            So my layout of sensors will be the same as the example car:
                            <br>
                            1. The Artemis Board will be put in the place of the original controlling chip;
                            <br>
                            2. The ToF that is beside the Artemis Board will be placed on one side of the cart;
                            <br>
                            3. The IMU will be placed on the surface of battery pack;
                            <br>
                            4. The other remote ToF will be placed on the front of the car.
                        </p>
                    </div>
                    
                    <div class="flex-grow-1">
                        <h3 class="mb-1">Avalibility</h3>
                        <div class="subheading mb-2">Check the avalibility of all the wired parts together</div>
                        <p>For the case that only one ToF is connected, I firstly scanned the I2C channel and found that the ToF is at address 0x29:</p>
                        <div align="center"><iframe width="640" height="360" src="https://www.youtube.com/embed/BOMUEbzIcOY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
                        <p>Then I tested the default mode of the ToF:</p>
                        <div align="center"><iframe width="640" height="360" src="https://www.youtube.com/embed/oRFMuAh-WGI" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
                        <p>After wiring all the parts together, I tested the functionality of IMU and Tof separately. Before testing, I manually set the addresses of the two ToFs respectively through xshut to ensure they work corretly.</p>
                    <pre><code>
             
    //Optional interrupt and shutdown pins.
    <span style="color:red;">
    #define SHUTDOWN_PIN0 0
    #define SHUTDOWN_PIN1 1
    </span>
    #define INTERRUPT_PIN 3
    
    <span style="color:red;">
    SFEVL53L1X distanceSensor0;
    SFEVL53L1X distanceSensor1;
    </span>
    //Uncomment the following line to use the optional shutdown and interrupt pins.
    //SFEVL53L1X distanceSensor(Wire, SHUTDOWN_PIN, INTERRUPT_PIN);
    
    void setup(void)
    {
        Wire.begin();
    
        Serial.begin(115200);
        <span style="color:red;">
        pinMode(SHUTDOWN_PIN0, OUTPUT);
        pinMode(SHUTDOWN_PIN1, OUTPUT)</span>
        Serial.println("VL53L1X Qwiic Test");
        <span style="color:red;">
        digitalWrite(SHUTDOWN_PIN0, LOW);
        digitalWrite(SHUTDOWN_PIN1, LOW);
        
        delay(50);
        digitalWrite(SHUTDOWN_PIN0, HIGH);
        delay(50);
        </span>
        if (distanceSensor0.begin() != 0) //Begin returns 0 on a good init
        {
        Serial.println("Sensor0 failed to begin. Please check wiring. Freezing...");
        }
        <span style="color:red;">
        else{
        distanceSensor0.setI2CAddress(0x29);
        }</span>
        //Serial.printf("port: 0x%08X\n", (uint32_t)distanceSensor0.getI2CAddress());
        Serial.println("Sensor0 online!");
    
        <span style="color:red;">
        delay(50);
        digitalWrite(SHUTDOWN_PIN1, HIGH);
        delay(50);</span>
        if (distanceSensor1.begin() != 0) //Begin returns 0 on a good init
        {
        Serial.println("Sensor1 failed to begin. Please check wiring. Freezing...");
        }
        <span style="color:red;">
        else{
        distanceSensor1.setI2CAddress(0x30);
        }</span>
        Serial.println("Sensor1 online!");
    }
    
    void loop(void)
    {
        distanceSensor0.startRanging(); //Write configuration bytes to initiate measurement
        while (!distanceSensor0.checkForDataReady())
        {
        delay(1);
        }
        int distance0 = distanceSensor0.getDistance(); //Get the result of the measurement from the sensor
        distanceSensor0.clearInterrupt();
        distanceSensor0.stopRanging();
    
        distanceSensor1.startRanging(); //Write configuration bytes to initiate measurement
        while (!distanceSensor1.checkForDataReady())
        {
        delay(1);
        }
        int distance1 = distanceSensor1.getDistance(); //Get the result of the measurement from the sensor
        distanceSensor1.clearInterrupt();
        distanceSensor1.stopRanging();
    
        Serial.print("Distance0(mm): ");
        Serial.print(distance0);
    
        float distanceInches0 = distance0 * 0.0393701;
        float distanceFeet0 = distanceInches0 / 12.0;
    
        Serial.print("\tDistance0(ft): ");
        Serial.print(distanceFeet0, 2);
        <span style="color:red;">
        Serial.print(" || ");
    
        Serial.print("Distance1(mm): ");
        Serial.print(distance1);
    
        float distanceInches1 = distance1 * 0.0393701;
        float distanceFeet1 = distanceInches1 / 12.0;
    
        Serial.print("\tDistance1(ft): ");
        Serial.print(distanceFeet1, 2);
        </span>
    
    
        Serial.println();
    }
                
                </code></pre>
                    <p>I first initialized the ToFs' xshuts to be 'LOW'. And then manually set their address via digitalWriting the xshuts to be "HIGH" one after another. And I found that only when one of them has been set to
                        a certain address, can I then digitalWrite the other's xshut to 'HIGH' and set the address for it. Otherwise one of them will not be detected, which means they may conflict in the same address.
                    </p>
                    <div align="center"><iframe width="560" height="315" src="https://www.youtube.com/embed/JNCaoR_aVbA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>

                    <p>
                        Then I tested the function of IMU. Before using Example1_Basics to test the IMU, I set the "AD0_VAL" to be "0", which means that the value of the last bit of IMU's I2C address is "0". Because the initial address of the IMU is
                        0x68, whose last bit in binary is "0".
                    </p>
                    <div align="center"><iframe width="560" height="315" src="https://www.youtube.com/embed/VmvBbJ3YtTg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
                    <p>So far, I had confirmed that all the parts wired together were working well.</p>

                    </div>

                    <div class="flex-grow-1">
                        <h3 class="mb-1">ToF</h3>
                        <div class="subheading mb-2">Send an ECHO command to the Artemis board and receive an augmented string on the computer</div>
                        <p>First complete the code for case ECHO in 'ble_arduino.ino'</p>
                        <div align="center"><img width="85%"  src="images/lab2/echocode.png" alt="echocode" title="echocode" /></div>
                        <figcaption class="mb-1" align="middle"> Code for Case ECHO </figcaption>
                        <p>Then send an ECHO command with a string value ("HiHello") from the computer to the Artemis board, and receive an augmented string on the computer via Jupyterlab</p>
                        <div align="center"></div>
                        <figcaption align="middle"> ECHO </figcaption>
                    </div>

                    <h3 class="mb-0">IMU</h3>

                    <div class="flex-grow-1">
                        <h3 class="mb-1">Accelerometer</h3>
                        <div class="subheading mb-2">Convert accelerometer data into pitch and roll</div>
                        <p>First complete the code for case SEND_THREE_FLOATS in 'ble_arduino.ino'</p>
                        <div class="subheading mb-2">Test frequency response</div>
                        <div align="center"><img width="85%"  src="images/lab2/3fcode.png" alt="3fcode" title="3fcode" /></div>
                        <figcaption class="mb-1" align="middle"> Code for Case SEND_THREE_FLOATS </figcaption>
                        <p>Then send an SEND_THREE_FLOATS command with 3 floats from the computer to the Artemis board via Jupyterlab, and extract the three float values in the Arduino sketch</p>
                        <div align="center"><img width="85%"  src="images/lab2/send3f.png" alt="send3f" title="send3f" /></div>
                        <figcaption class="mb-1" align="middle"> ble.SEND_THREE_FLOATS </figcaption>
                        <div align="center"><img width="85%"  src="images/lab2/extract3f.png" alt="extract3f" title="extract3f" /></div>
                        <figcaption align="middle"> Extract Three Floats </figcaption>
                    </div>

                    <div class="flex-grow-1">
                        <h3 class="mb-1">Gyroscope</h3>
                        <div class="subheading mb-2">Compute pitch, roll, and yaw angles from the gyroscope</div>
                        <p>First, define a function update for the ble.start_notify, making it print the float whenever it is updated.
                            Then, setup a notification handler in Python using ble.start_notify and set the ble.uuid to be 'RX_FLOAT' to receive the float value (the BLEFloatCharactersitic in Arduino) from the Artemis board.
                            In the callback function, store the float value into a (global) variable such that it is updated every time the characteristic value changes</p>

                        <div class="subheading mb-2">Test accuracy and stablility</div>
                        <div align="center"><img width="85%"  src="images/lab2/notify.png" alt="Notify" title="Notify" /></div>
                        <figcaption align="middle"> Notify </figcaption>
                    </div>

                    <h3 align="center" class="mb-0">5960 Task</h3>

                    <div class="flex-grow-1">
                        <h3 class="mb-1">Magnetometer</h3>
                        <div class="subheading mb-0">Convert magnetometer data into a yaw angle</div>
                        <div class="subheading mb-2">Find the magnetic north</div>
                        <div class="subheading mb-2">Robust to small changes in pitch</div>
                        <p>The data size for a float is 4 bytes, and the data size for a string differs from the chars it contains. And for a basic foat 0.0, the size of the string representing 0.0 is also 4 bytes
                            (including the pause at the end of the string). So its definitely better to use the first method whose data size is constantly 4 bytes which contains full information of a float. 
                        </p>
                    </div>

                    
            </section>
            <hr class="m-0" />
           
        </div>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
